---
- name: Smart Deployment (Auto-detect and Install)
  hosts: all
  gather_facts: yes
  become: yes
  
  vars:
    app_name: petclinic
    app_host_port: 8080
    with_nginx: false
    acr_server: "{{ lookup('env', 'ACR_SERVER') | default('', true) }}"
    acr_username: "{{ lookup('env', 'ACR_USERNAME') | default('', true) }}"
    acr_password: "{{ lookup('env', 'ACR_PASSWORD') | default('', true) }}"
  
  pre_tasks:
    - name: Check Docker
      command: docker --version
      register: docker_check
      ignore_errors: yes
      changed_when: false
    
    - name: Check Nginx
      command: nginx -v
      register: nginx_check
      ignore_errors: yes
      changed_when: false
    
    - name: Show what will be installed
      debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "INSTALLATION PLAN"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Docker: {{ 'Already installed âœ…' if docker_check.rc == 0 else 'Will install ğŸ“¦' }}"
          - "Nginx:  {{ 'Already installed âœ…' if nginx_check.rc == 0 else ('Will install ğŸ“¦' if with_nginx else 'Skipped â­ï¸') }}"
          - "App:    Will deploy ğŸš€"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  
  roles:
    - bootstrap
    - role: docker
      when: docker_check.rc != 0
    - app-deploy
    - role: nginx
      when: with_nginx | bool and nginx_check.rc != 0
  
  post_tasks:
    - name: Show results
      debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "âœ… DEPLOYMENT COMPLETE"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Direct:  http://{{ ansible_host | default('localhost') }}:{{ app_host_port }}"
          - "{{ 'Nginx:   http://' + (ansible_host | default('localhost')) if with_nginx else 'Nginx:   Not configured' }}"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
