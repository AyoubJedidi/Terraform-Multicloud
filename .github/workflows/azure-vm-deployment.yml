name: Azure VM Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      destroy_after:
        default: 'no'
      app_image:
        default: 'nginx:alpine'

env:
  TERRAFORM_VERSION: '1.10.3'
  TF_VAR_project_name: 'petclinic-cicd'
  TF_VAR_environment: 'dev'
  TF_VAR_cloud_provider: 'azure'
  TF_VAR_deployment_type: 'docker-vm'
  TF_VAR_azure_resource_group: 'petclinic-cicd-rg'
  TF_VAR_azure_location: 'francecentral'

jobs:
  terraform-provision:
    name: ðŸ—ï¸ Provision VM
    runs-on: ubuntu-latest
    
    outputs:
      vm_ip: ${{ steps.output.outputs.vm_ip }}
    
    defaults:
      run:
        working-directory: terraform/parent
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
      
      - name: Azure Login
        run: |
          az login --service-principal \
            --username ${{ secrets.AZURE_CLIENT_ID }} \
            --password ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}
          
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Apply
        run: terraform apply -auto-approve
      
      - name: Export Outputs
        id: output
        run: |
          VM_IP=$(terraform output -raw vm_public_ip)
          echo "vm_ip=$VM_IP" >> $GITHUB_OUTPUT
          
          terraform output -json > terraform_outputs.json
          terraform output -raw vm_private_key > vm_private_key.pem
          chmod 600 vm_private_key.pem
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: |
            terraform/parent/terraform_outputs.json
            terraform/parent/vm_private_key.pem

  ansible-deploy:
    name: ðŸš€ Deploy App
    needs: terraform-provision
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ansible-deployment
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common jq
          sudo add-apt-repository --yes --update ppa:ansible/ansible
          sudo apt-get install -y ansible
      
      - name: Download Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs
          path: terraform-outputs
      
      - name: Setup Files
        run: |
          mkdir -p ssh_keys
          cp ../terraform-outputs/vm_private_key.pem ssh_keys/azure_vm.pem
          chmod 600 ssh_keys/azure_vm.pem
          cp ../terraform-outputs/terraform_outputs.json .
      
      - name: Generate Inventory
        run: |
          chmod +x generate_inventory.sh
          ./generate_inventory.sh
      
      - name: Wait for SSH
        run: |
          VM_IP="${{ needs.terraform-provision.outputs.vm_ip }}"
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
                   -i ssh_keys/azure_vm.pem azureuser@$VM_IP "echo Ready"; then
              exit 0
            fi
            sleep 10
          done
          exit 1
      
      - name: Deploy
        run: |
          ansible-playbook playbooks/deploy-smart.yml \
            -e "app_image=${{ github.event.inputs.app_image || 'nginx:alpine' }}" \
            -e "app_host_port=80" \
            -e "app_container_port=80"
      
      - name: Summary
        run: |
          VM_IP="${{ needs.terraform-provision.outputs.vm_ip }}"
          echo "ðŸŽ‰ Deployed to: http://$VM_IP"
          ansible all -m shell -a "docker ps"
