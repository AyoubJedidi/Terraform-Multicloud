name: Azure VM Deployment with Ansible

on:
  push:
    branches: [ main ]  # âœ… Already correct
    paths:
      - 'terraform/**'
      - 'ansible-deployment/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      destroy_after:
        description: 'Destroy VM after deployment (yes/no)'
        required: false
        default: 'no'
      app_image:
        description: 'Docker image to deploy'
        required: false
        default: 'nginx:alpine'

env:
  TERRAFORM_VERSION: '1.10.3'
  TF_VAR_project_name: 'petclinic-cicd'
  TF_VAR_environment: 'dev'
  TF_VAR_cloud_provider: 'azure'
  TF_VAR_deployment_type: 'docker-vm'
  TF_VAR_azure_resource_group: 'petclinic-cicd-rg'
  TF_VAR_azure_location: 'francecentral'

jobs:
  terraform-provision:
    name: ğŸ—ï¸ Provision Azure VM
    runs-on: ubuntu-latest
    
    outputs:
      vm_ip: ${{ steps.output.outputs.vm_ip }}
      vm_username: ${{ steps.output.outputs.vm_username }}
    
    defaults:
      run:
        working-directory: terraform/parent
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
      
      - name: ğŸ”‘ Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ğŸ¯ Terraform Init
        run: terraform init
      
      - name: ğŸ“‹ Terraform Validate
        run: terraform validate
      
      - name: ğŸ“Š Terraform Plan
        run: terraform plan -out=tfplan
      
      - name: ğŸš€ Terraform Apply
        run: terraform apply -auto-approve tfplan
      
      - name: ğŸ“¤ Export Terraform Outputs
        id: output
        run: |
          VM_IP=$(terraform output -raw vm_public_ip)
          VM_USER=$(terraform output -raw vm_username)
          
          echo "vm_ip=$VM_IP" >> $GITHUB_OUTPUT
          echo "vm_username=$VM_USER" >> $GITHUB_OUTPUT
          
          echo "âœ… VM Created: $VM_IP"
          
          terraform output -json > terraform_outputs.json
          terraform output -raw vm_private_key > vm_private_key.pem
          chmod 600 vm_private_key.pem
      
      - name: ğŸ“¦ Upload Terraform Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: |
            terraform/parent/terraform_outputs.json
            terraform/parent/vm_private_key.pem
          retention-days: 1

  ansible-deploy:
    name: ğŸš€ Deploy with Ansible
    needs: terraform-provision
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ansible-deployment
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common jq
          sudo add-apt-repository --yes --update ppa:ansible/ansible
          sudo apt-get install -y ansible
          ansible --version
      
      - name: ğŸ“¥ Download Terraform Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs
          path: terraform-outputs
      
      - name: ğŸ” Setup Files
        run: |
          mkdir -p ssh_keys
          cp ../terraform-outputs/vm_private_key.pem ssh_keys/azure_vm.pem
          chmod 600 ssh_keys/azure_vm.pem
          cp ../terraform-outputs/terraform_outputs.json .
      
      - name: ğŸ“ Generate Inventory
        run: |
          chmod +x generate_inventory.sh
          ./generate_inventory.sh
          cat inventory/hosts.ini
      
      - name: â³ Wait for VM SSH
        run: |
          VM_IP="${{ needs.terraform-provision.outputs.vm_ip }}"
          echo "Waiting for SSH on $VM_IP..."
          
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
                   -i ssh_keys/azure_vm.pem \
                   azureuser@$VM_IP "echo 'Ready'"; then
              echo "âœ… SSH ready!"
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 10
          done
          
          echo "âŒ SSH timeout"
          exit 1
      
      - name: ğŸ§ª Test Ansible
        run: |
          ansible all -m ping
          ansible all -m command -a "hostname"
      
      - name: ğŸ³ Deploy Application
        env:
          APP_IMAGE: ${{ github.event.inputs.app_image || 'nginx:alpine' }}
        run: |
          ansible-playbook playbooks/deploy-smart.yml \
            -e "app_image=$APP_IMAGE" \
            -e "app_name=webapp" \
            -e "app_host_port=80" \
            -e "app_container_port=80" \
            -e "with_nginx=false" \
            -v
      
      - name: âœ… Verify Deployment
        run: |
          VM_IP="${{ needs.terraform-provision.outputs.vm_ip }}"
          
          sleep 15
          
          echo "Testing from VM..."
          ansible all -m shell -a "curl -I http://localhost:80"
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "VM IP:        $VM_IP"
          echo "Application:  http://$VM_IP"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ansible all -m shell -a "docker ps"

  terraform-destroy:
    name: ğŸ—‘ï¸ Cleanup
    needs: [terraform-provision, ansible-deploy]
    runs-on: ubuntu-latest
    if: github.event.inputs.destroy_after == 'yes'
    
    defaults:
      run:
        working-directory: terraform/parent
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: ğŸ”‘ Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ğŸ¯ Terraform Init
        run: terraform init
      
      - name: ğŸ—‘ï¸ Terraform Destroy
        run: terraform destroy -auto-approve
