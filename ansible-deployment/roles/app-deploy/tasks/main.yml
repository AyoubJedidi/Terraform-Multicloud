---
- name: Determine if registry image
  set_fact:
    is_registry_image: true

- name: Show image info
  debug:
    msg: "Deploying image: {{ app_image }}"

- name: Login to container registry
  docker_login:
    registry: "{{ acr_server }}"
    username: "{{ acr_username }}"
    password: "{{ acr_password }}"
  when: 
    - acr_server is defined
    - acr_server != ''
    - acr_username is defined
    - acr_username != ''
  no_log: true

- name: Pull application image
  docker_image:
    name: "{{ app_image }}"
    source: pull

- name: Stop old container
  docker_container:
    name: "{{ app_name }}"
    state: absent
  ignore_errors: yes

- name: Start application container
  docker_container:
    name: "{{ app_name }}"
    image: "{{ app_image }}"
    state: started
    restart_policy: always
    ports: "{{ app_ports }}"
    env: "{{ app_env | default({}) }}"

- name: Wait for application to be ready
  wait_for:
    port: "{{ app_host_port }}"
    delay: 5
    timeout: 120

- name: Check application health
  uri:
    url: "http://localhost:{{ app_host_port }}"
    status_code: 200
  retries: 10
  delay: 5

- name: Show deployment status
  debug:
    msg: "âœ… Application {{ app_name }} is running on port {{ app_host_port }}"
